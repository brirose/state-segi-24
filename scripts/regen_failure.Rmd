---
title: "Regen Failure"
author: "Shive Lab (B. Baker)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = F, warning = F, error = F)

library(here)
library(tidyverse)
library(janitor)
library(sf)
library(terra)

```

This document holds the analysis for regeneration failure areas.

```{r import_data}
#BA 7-class fires that have had high sev and are in groves 1984-2024 
# need to switch this to: 801-1100 mod risk, >1101 high risk; rdnbr
sev_class7 <- st_read(here("data/spatial_data/outputs/ba_highsev_7/ba_highsev_7.shp"))

#polygons of SEGI groves, "skinny"
groves <- st_read(here("data/spatial_data/inputs/forest/2023_GS_Groves_OTI_public.gdb"), layer = "OGS_Groves_2023_97_public") %>%
  clean_names() %>%
  st_transform(crs(sev_class7)) %>% #uniform crs
  st_cast("MULTIPOLYGON") %>% 
  st_make_valid()

```

We will consider areas that fall into the highest burn severity category as those where regeneration failure is likely. The layer I am starting from contains rdnbr for fires from 1984-2023 that both burned at high severity and burned sequoia groves.

```{r sev_polygons}

# filter to only include the highest severity
high_sev <- sev_class7 %>% 
  filter(burnsev == 7)  # highest severity is 7 need to switch this to: 801-1100 mod risk, >1101 high risk; rdnbr

#st_write(high_sev, here("data/spatial_data/outputs/highsev_debug.shp") ,append = F)
```

Lower severity classes can act as seed source into gaps. Per Clark's seed dispersal model 95% of seeds fall within 67.8m of a tree, so we can assume that seed dispersal into gaps created by high severity fire will most likely occur in this zone and we will want to buffer this out when trying to ascertain where regen failure is likely. 

Here, I make a layer that represents seed source (grove area that has not experienced category 7 fire). Then I use this to find areas where dispersal is likely by adding a 67.8m buffer.

```{r seed_source}

# sf package was not working, convert to terra-friendly objects
groves <- vect(groves)
high_sev <- vect(high_sev)

disbursal_area <- erase(groves, high_sev) %>% 
  buffer(width = 67.8)
  
```

Once I know where dispersal is likely, I can difference the highest severity layer to determine where regeneration failure is highly likely.

```{r regen-failure}
#start with high sev area
regen_fail <- erase(high_sev, disbursal_area) %>% # erase areas where disbursal happens
  intersect(groves) # select groves only

writeVector(regen_fail, here("data/spatial_data/outputs/regenfail_debug.shp"), overwrite = T)



```


