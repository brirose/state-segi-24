---
title: "Regen Failure"
author: "Shive Lab (B. Baker)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = F, warning = F, error = F)

library(here)
library(tidyverse)
library(janitor)
library(sf)
library(terra)
library(kableExtra)

```

This document holds the analysis for regeneration failure areas.

actually check the crs/make match

```{r import_data}

##check that same crs

# rdnbr fires that have had high sev and are in groves 1984-2024 
#double check this layer (looking for reburn area) -- will need to see spatially + temporally 
sev_rdnbr <- rast(here("data/spatial_data/outputs/rdnbr_severe-fires_cropped/needFires_rdnbr.tif"))

#polygons of SEGI groves, "skinny"
groves <- vect(here("data/spatial_data/inputs/forest/2023_GS_Groves_OTI_public.gdb"), layer = "OGS_Groves_2023_97_public") %>%
  clean_names() %>% 
  project(sev_rdnbr)

```

We will consider areas that fall into the highest burn severity category as those where regeneration failure is likely. The layer I am starting from contains rdnbr for fires from 1984-2023 that both burned at high severity and burned sequoia groves.

want to split up the classes!

```{r sev_polygons}


#select  rdnbr 801-1100 mod risk and >1101 high risk
reclass_matrix <- tibble(
  from = c(-10498, 801, 1100),
  to = c(801, 1100, 9992),
  becomes = c(1, 3, 4)
)

# filter to only include the highest severity
immediate_regen_failure <- sev_rdnbr %>% 
  classify(reclass_matrix,
           right = F, # include "from" value in category
           include.lowest = T) %>% #include max value
  as.polygons() %>% 
  st_as_sf() %>% 
  rename(sev_class = rdnbr) %>% 
  summarise(.by = sev_class, geometry = st_combine(geometry)) %>% 
  mutate(area_ha = as.numeric(st_area(.))*0.0001) %>% 
  filter(sev_class != 1)

st_write(immediate_regen_failure, here("data/spatial_data/immediate_failure.shp"))


immediate_failure <- st_drop_geometry(immediate_regen_failure) %>% 
  mutate(
    failure = case_when(
      sev_class == 3 ~ "high failure",
      sev_class == 4 ~ "complete failure"
    )
  )
#output high and mod risk by grove

total_ha <- sum(immediate_failure$area_ha)
total_perc <- total_ha/sum(groves$acres)*100

immediate_failure <- immediate_failure %>% 
  add_row(.before = 1, grove_name = "Total", 
        area_ha = total_ha, failure_perc = total_perc)

```

Lower severity classes can act as seed source into gaps. Per Clark's seed dispersal model 95% of seeds fall within 67.8m of a tree, so we can assume that seed dispersal into gaps created by high severity fire will most likely occur in this zone and we will want to buffer this out when trying to ascertain where regen failure is likely. 

Here, I make a layer that represents seed source (grove area that has not experienced category 7 fire). Then I use this to find areas where dispersal is likely by adding a 67.8m buffer.

```{r seed_source}

# make high sev 640 and greater
reclass_matrix2 <- tibble(
  from = c(-10498, 640),
  to = c(640, 9992),
  becomes = c(1, 2)
)

high_sev <- sev_rdnbr %>% 
  classify(reclass_matrix2,
           right = F, # include "from" value in category
           include.lowest = T) %>% #include max value
  as.polygons() %>% 
  st_as_sf() %>% 
  rename(sev_class = rdnbr) %>% 
  summarise(.by = sev_class, geometry = st_combine(geometry)) %>% 
  filter(sev_class == 2) %>% 
  vect()

disbursal_area <- erase(groves, high_sev) %>% #take high severity area out of groves
  buffer(width = 67.8) #buffer by 67.8m 


```

Once I know where dispersal is likely, I can difference the highest severity layer to determine where regeneration failure is highly likely.

```{r regen-failure}
#start with high sev area
regen_fail <- erase(groves, disbursal_area) %>%  #erase areas where disbursal happens
  subset(select = c("grove_name", "acres"), NSE = T) #select only grove name

regen_fail$area_ha <- expanse(regen_fail, unit = "ha") #calculate area affected


#writeVector(regen_fail, here("data/spatial_data/outputs/regenfail.shp"), overwrite = T)

```

```{r outputs}

regen_fail_sf <- st_as_sf(regen_fail) %>% 
 st_drop_geometry() %>% 
  mutate(
    grove_ha = acres/2.471,
    failure_perc = area_ha/grove_ha*100) %>% 
  select(grove_name, area_ha, failure_perc) %>% 
  arrange(-area_ha)

total_ha <- sum(regen_fail$area_ha)
total_perc <- total_ha/sum(groves$acres)*100

regen_fail_sf <- regen_fail_sf %>% 
  add_row(.before = 1, grove_name = "Total", 
        area_ha = total_ha, failure_perc = total_perc)

kable(regen_fail_sf,
      digits = 1,
      caption = "Area at risk to long-term natural regeneration failure by grove")

```

