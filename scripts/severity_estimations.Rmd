---
title: "Severity Estimations"
author: "Shive Lab (B. Baker)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(sf)
library(terra)
library(readxl)
library(kableExtra)
library(janitor)
```

## Load Data

To make severity estimates, I will use our complete CBI layer

```{r load}

#four-class CBI severity for all fires that intersect groves, not clipped to groves
cbi_all <- st_read(here("data/spatial_data/outputs/cbi_all/cbi_all.shp"))

cbi_all$area_ha_total <- as.numeric(st_area(cbi_all))*0.0001

#polygons of SEGI groves, "skinny"
groves <- st_read(here("data/spatial_data/inputs/forest/2023_GS_Groves_OTI_public.gdb"), layer = "OGS_Groves_2023_97_public") %>%
  clean_names() %>%
  st_transform(crs(cbi_all)) %>% #uniform crs
  st_cast("MULTIPOLYGON") %>% 
  st_make_valid()

```

```{r grove_clip}

#CBI severity for fires that intersect groves, clipped to groves

cbi_clipped <- st_intersection(cbi_all, groves)
cbi_clipped <- cbi_clipped %>% 
  rename("grov_nm" = "grove_name") %>% 
  select(grov_nm, id, burnsev, fire_yr) 

cbi_clipped$area_ha_grove <- as.numeric(st_area(cbi_clipped))*0.0001 

```
## Known fires in groves since perimeters started

```{r}

all_fires <- st_read(here("data/spatial_data/inputs/fire/fire22_1.gdb"), layer = "firep22_1") %>% 
  clean_names() %>%
  st_transform(crs(cbi_all)) %>%  #make consistent crs
  st_cast("MULTIPOLYGON") %>% 
  rownames_to_column() %>% 
  st_intersection(groves) 

all_fires <- all_fires %>% 
  mutate(fire_name = case_when(!str_detect(fire_name, " ") ~ str_to_title(fire_name), 
                               T ~ paste("unknown", rowname, sep = "_")),
         area_ha = as.numeric(st_area(.))*0.0001,
         area_acres = area_ha/2.471) %>% 
  st_drop_geometry() %>% 
select(year, fire_name, grove_name, area_ha, area_acres)
```



## Fire List

```{r}

all_area <- cbi_all %>% 
  st_drop_geometry() %>% 
  arrange(burnsev) %>% 
  pivot_wider(names_from = burnsev, names_prefix = "all_ha_",values_from = area_ha_total, values_fill = 0) %>% 
  select(!all_ha_255)%>% 
  mutate(all_ha_total = all_ha_1 + all_ha_2 + all_ha_3 + all_ha_4)

grove_area <- cbi_clipped %>% 
  st_drop_geometry() %>% 
  arrange(burnsev) %>% 
  summarise(.by = c(id, burnsev), area_ha_grove = sum(area_ha_grove), grove_ct = length(unique(grov_nm))) %>% 
  pivot_wider(names_from = burnsev, names_prefix = "grove_ha_",values_from = area_ha_grove, values_fill = 0) %>% 
  mutate(grove_ha_total = grove_ha_1 + grove_ha_2 + grove_ha_3 + grove_ha_4)

by_grove <- cbi_clipped %>% 
  st_drop_geometry() %>% 
  summarise(.by= c(id, grov_nm, burnsev), area_ha_grove = sum(area_ha_grove)) %>% 
  pivot_wider(names_from = burnsev, names_prefix = "ha_",values_from = area_ha_grove, values_fill = 0) %>% 
  arrange(id) %>% 
  mutate(ha_total = ha_1 + ha_2 + ha_3 + ha_4) %>% 
  filter(ha_total > 0.01)

grove_count <- by_grove %>% 
  summarize(.by = c(id), grove_count = n())

fire_sev_ha <- left_join(grove_area, all_area) %>% 
  left_join(grove_count) %>% 
  select(-fire_yr, -assss_t) %>% 
  arrange(id)


kable(fire_sev_ha, 
      digits = 1,
      caption = "Fire size and severity for fires that burned SEGI groves 1983-2024")


kable(by_grove, 
      digits = 1,
      caption = "Fire severity size for fires that burned SEGI groves 1983-2024 by grove")

```





## Prelim Figures for Communications

```{r}
#make master dataframe


#need to append info from 2023-2024

recent_fire <- by_grove %>% 
  filter(str_detect(id, "2024")) %>%  #no fires in 2023 somehow, so just need 2024
  mutate(year = "2024", area_acres = ha_total/2.471) %>%
  rename(
    grove_name = grov_nm,
    fire_name = id
  )

all_fires_summary <- all_fires %>% 
  bind_rows(recent_fire) %>% 
  summarize(.by = year, 
            grove_count = length(unique(grove_name)),
            fire_count = length(unique(fire_name)),
            area_acres_total = sum(area_acres)) %>% 
  mutate(year = as.numeric(year)) %>% 
  arrange(year)

#fire area in groves by severity breakdown by year

severity_summary <- grove_area %>% 
  mutate(year = parse_number(id),
         fire = str_to_title(str_extract(id, "(?<=\\d{4}).+"))) %>% 
  pivot_longer(grove_ha_1:grove_ha_4) %>% 
  summarise(
    .by = c(year, name),
    area_acres = sum(value/2.471)
      ) %>% 
  mutate(
    severity = parse_number(name)
  ) %>% 
  select(-name) %>% 
  pivot_wider(names_from = severity, names_prefix = "area_acres_", values_from = area_acres)


#combine

all_fires_summary <- all_fires_summary %>% 
  left_join(severity_summary)

```


```{r}


```



```{r}
# All fire area in groves since recording began



#now make bar chart
  

```



