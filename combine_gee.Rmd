---
title: "Combine and Classify Fire Severity"
author: "Shive Lab (B. Baker)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(terra)
library(here)

```

#Combine Rasters from GEE

```{r}
# #Load seperate rdmbr rasters -- maybe automate later
# case <- rast(here("data/spatial_data/needSeverity_state-of-segi/CASE_1987_rdnbr.tif"))
# 
# circle <- rast(here("data/spatial_data/needSeverity_state-of-segi/CIRCLE_2002_rdnbr.tif"))
# 
# deer <- rast(here("data/spatial_data/needSeverity_state-of-segi/DEER-CREE_1991_rdnbr.tif"))
# 
# panther <- rast(here("data/spatial_data/needSeverity_state-of-segi/PANTHER_1994_rdnbr.tif"))
# 
# tharp <- rast(here("data/spatial_data/needSeverity_state-of-segi/THARPS_2018_rdnbr.tif"))

```

```{r}
# ## make spatial raster collection
# s <- sprc(case, circle, deer, panther, tharp)
# 
# ## merge rasters
# severity_rdnbr <- merge(s)
# 
# #output new combined raster
# writeRaster(severity_rdnbr, here("data/spatial_data/needSeverity_rdnbr.tif"))

severity_rdnbr <- rast(here("data/spatial_data/needSeverity_rdnbr.tif"))

```

```{r}
#view to visualize
plot(severity_rdnbr)

```

#Classify to Basal Area % Change Severity

Breaks follow the 7 class % change in Basal Area severity used in the R5:Veg Burn Severity BA.

* 0% Change (0.00001)
* 0% < Change < 10% (10)
* 10% <= Change < 25% (25)
* 25% <= Change < 50% (50)
* 50% <= Change < 75% (75)
* 75% <= Change < 90% (90)
* Change > 90%

To classify the rdnbr raster using these breaks, we will need to determine the corresponding rdnbr value for the BA perc. This is done using the equation in miller 2009, Table 3 (!https://www.fs.usda.gov/psw/publications/knapp/psw_2009_knapp(miller)001.pdf).

RdNBR = a + b ‚Åé ASIN(SQRT(PctBA / 100)) where a = 166.5, b = 389.0

```{r}
#define breaks


breaks <- tibble(
  ba_from = c(0, 0.00001, 10.00001, 25.00001, 50.00001, 75.00001, 90.00001),
  ba_to = c(0.00001, 10, 25, 50, 75, 90, 100), #breaks in BA
  rdnbr_from = 166.5 + 389 * asin(sqrt(ba_from/100)),
  rdnbr_to = 166.5 + 389 * asin(sqrt(ba_to/100)),
  becomes = c("0% Change", "0% < Change < 10%", "10% <= Change < 25%", "25% <= Change < 50%","50% <= Change < 75%", "75% <= Change < 90%", "Change > 90%"))


```



```{r}
#convert breaks



```

